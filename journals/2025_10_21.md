# CloudHSM #security #cloudhsm
collapsed:: true
	- [CloudHSM | Resources | hashicorp/aws | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudhsm_v2_cluster)
	- AWS provisions the encryption HW
		- Dedicated HW (HSM -> Hardware Security Module)
			- HSM devices are tamper resistant, FIPS 140-2 Level 3 compliance
		- You manage your own encryption keys entirely
		- Supports both symmetric and asymmetric encryption (SSL/TLS keys)
		- **NO FREE-TIER AVAILABLE**
		- **MUST** use the CloudHSM Client SW
			- Manage keys and users access
		- Redshift supports CloudHSM for database encryption and key management
		- Good option to use with SSE-C encryption
	- IAM Permissions -> CRUD an HSM Cluster
	- Ensure HA using 2 HSM devices in 2 different AZs
	- CloudHSM vs. KMS
		- Single-Tenant vs. Multi-Tenant
		- Only CMK vs. AWS Owned/Managed Keys + CMK
		- Symmetric/Asymmetric + Digital Signing vs. Digital Signing + Hashing
		- Cryptographic Acceleration vs. None
		- Manage access & auth. creation and manage users vs. using IAM
		- No free-tier vs. free-tier
		- Supports MFA vs. not support MFA
		- AWS-managed service vs. customer-managed HSM devices
- ## Solution Architecture: SSL on ALB #security #sa #elb
  collapsed:: true
	- Common solution -> configure ACM to use SSL certificates in ALB
	- Other solution is to configure SSL on web servers, ensuring the internal traffic use HTTPS
		- Using the EC2 user-data, access to SSM Parameter Store and retrieve SSL private key at EC2 boot time
		- Install certs on EC2
	- Another solutions implies CloudHSM, which is called **SSL Offloading**
		- The **MOST** secure and handy solution
		- SSL Acceleration, supported by NGINX, Apache Web and IIS for Windows Server
		- You could configure SSL Acceleration to ensure the SSL private key never leaves the HSM device
			- **MUST** setup a cryptographic user on the CloudHSM device to be used by EC2 instances
- # S3 Security #security #s3
  collapsed:: true
	- Client-Side Encryption -> uncommon, you **MUST** manage your own encryption keys
	- **Server-Side Encryption**
		- **SS3-S3**: keys handled & managed by AWS
		- **SSE-KMS**: leverage KMS to manage encryption keys
		- **SSE-C**: when you want to manage your own encryption keys
		- On Glacier, all data is AES-256 encrypted, key under AWS control
	- AWS S3 exposes HTTP and HTTPS endpoints
		- HTTPS is recommended (for SSE-C is mandatory), but not enforced
			- To enforce HTTPS, use *aws:SecureTransport* in the bucket policy
	- Events in S3 buckets
		- S3 Access Logs
			- Detailed records for the request that are made to a bucket
			- Might take hours to deliver and being incomplete (best effort)
		- S3 Events Notifications
			- Receive notification when certain events happen in your bucket
				- Object creation, removal, restore, replication events
			- Destinations: SNS, SQS queue, AWS Lambda
			- Typically delivered in seconds but it can take minutes (versioning enabled, )
		- Trusted Advisor
			- Check the bucket permission
		- Amazon EventBridge
			- Need to enable CloudTrail object level logging on S3 first
			- Target can be Lambda, SQS, SNS...
	- S3 Security
		- User-based
			- IAM policies - which APi calls should be allowed for a specific user from IAM console
		- Resource-based
			- Bucket Policies
				- Grant public access to the bucket
				- Force object to be encrypted at upload
				- Grant access to another account
				- Optional conditions
					- SourceIP (public IP) / VpcSourceIp (Private IP)
					- Source VPC or Source VPC Endpoints
					- CloudFront Origin Identity
					- MFA
					- You cannot restrict EC2 instances roles/IAM roles
			- Object & Bucket ACLs
	- S3 pre-signed URLs
		- Generated pre-signed URLs using SDK or CLI
			- For downloads (CLI) or uploads (SDK)
		- Valid for 3600 by default, you can change it with --expires-in parameter
		- Users given a pre-signed URE inherit the permissions of the person who generated the URL
	- VPC Endpoint Gateway for S3 -> Access to S3 privately
		- AWS:SourceVpce OR AWS:SourceVpc bucket policy conditions
	- S3 Object Lock
		- Adopt a WORM model, block an object version deletion for a specific amount of time
	- Glacier Vault Lock
		- Adopt a WORM model, lock the policy for future edits. Helpful for compliance and data retention
- # S3 Access points #security #s3
  collapsed:: true
	- [aws_s3_access_point | Resources | hashicorp/aws | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_access_point)
	- Access Points simplify security management for S3 buckets
		- Its own DNS name
		- Access Point policy to manage security at scale
	- Create an access point and assign it a specify bucket policy to grant access to just x folders on the bucket
	- VPC Origin
		- Define accessibility (public or private)
		- You **MUST** create a VPC Endpoint to access the Access Point
		- VPC Endpoint policy **MUST** allow access to the target bucket and Access Point
- # S3 Multi-Region Access Points #security #s3
  collapsed:: true
	- [aws_s3control_multi_region_access_point | Resources | hashicorp/aws | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3control_multi_region_access_point)
	- Provide a global endpoint that span S3 buckets in multiple AWS Regions
	- Dynamically route requests to the nearest S3 bucket (lowest latency)
	- Two-way directional S3 bucket replication rules are created to keep data in sync across regions
	- Fail-over Controls - allows you to shift requests across S3 buckets in different AWS regions within minutes (Active-Active or Active-Pasive)
		- You go to the active lowest latency bucket. If it exists a regional traffic disruption, the fail-over is initiated and requests are forwarded to other bucket.
	- ## S3 Multi-Region Access Points - Hands On #security #s3 #sa
		- Up to 24 hours to create one
		- Buckets versioning **MUST** be enabled to create replication rules
		- Network traffic cost-based
- # S3 Object Lambda #security #s3
  collapsed:: true
	- [aws_s3control_object_lambda_access_point | Resources | hashicorp/aws | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3control_object_lambda_access_point)
	- Use AWS Lambda Functions to change the object before it is retrieved by the caller app
	- Only one S3 bucket is needed, on top of which we create S3 Access Point and S3 Object lambda Access Points
	- Use cases:
		- Redacting PIIs for analytics or non-prod environments
		- Converting across data formats, such as converting XML to JSON
		- Resizing and watermarking images on the fly using caller-specific details, such as the user who requested the object.