# IAM #iam
collapsed:: true
	- **User**, **user groups**: long-term credentials
	- **Roles**: short-term credentials, uses STS
		- EC2 Instance Roles, Service Roles, Cross Account Roles
	- **Policies**
		- AWS Managed (*AdministratorAccess*, *PowerUser*), Customer Managed, Inline Policies
		- Resource Bases Policies
			- Supported by S3 buckets, Lambda functions, SQS queues, SNS topics, and so on.
		- **Explicit DENY has precedence over ALLOW (least privilege principle)**
			- **Access Advisor**: see permissions granted and usage
			- **Access Analyzer**: external entities
		- JSON doc with the following parameters:
			- Effect
			- Action
			- Resource
			- Conditions *"Condition": { "<operator>": {"key": "value"} }*
				- **String**, **Numeric**, **Date**, **Boolean**, **(Not)IpAddress**, **ArnEquals**, **ArnLike**, **Null**
			- Policy Variables and Tags
				- *${<variable>}*
				- AWS Specific -> *${aws:<variable>}*
				- Service Specific -> *${<service_name>:<variable>}*
				- Tag Based -> *${<aws | service_name>:<ResourceTag | PrincipalTag>/<tag_name>}*
	- **IAM Roles vs Resource Based Policies**
		- When you assume a role, you give up your original permission and take the permissions assigned to the role
		- When using a resource-based policy, the principal doesn't have to give up any permissions
		- Example of both usage: *User in account A needs to scan a DynamoDB table in account A and dump it in an S3 bucket in account B*
	- **IAM Permission Boundaries**
		- Supported for users and roles, not for groups
			- **Sets the maximum permissions an IAM entity can get**
		- Can be used in combination with AWS Organizations SCP
		- Use cases:
			- Delegate responsabilities to non administrators
			- Allow devs to self-assign policies and manage their own permissions, without privileges escalation
			- Restrict specific users
- # IAM Access Analyzer #iam
  collapsed:: true
	- **Find out which resources are shared externally**
		- S3 buckets, IAM roles, KMS keys, Lambda functions and layers, SQS wueues, Secrets Manager secrets
		- Define **Zone of Trust**: AWS Accounts or Organizations
		- Access outside zone for trust -> **findings**
		- **IAM Access Analyzer Policy Validator**
			- Validates your policy against IAM policy grammar and best practices
				- General warnings, security warnings, errors, suggestions
				- Provides actionable recommendations
		- **IAM Access Analyzer Policy Generation**
			- Generates IAM policy based on access activity (CloudTrail Logs for up to 90 days) with the fine-grained permissions and the appropriate Actions and Services
- # Security Token Service (STS) #iam
  collapsed:: true
	- Define an IAM Role within your account or cross-account
	- Define which principals can access this IAM Role
	- Uses STS to retrieve temporary credentials and impersonate the IAM Role you have access to
		- Credentials can be valid between 15 minutes to 12 hours. Default is 1 hour
	- Ability to revoke active sessions and credentials for a role -> **AWSRevokeOlderSessions**
	- Providing access to an IAM User in your account or another one that you own
		- You **MUST** explicit grant your users permissions to assume the role
		- Your users **MUST** actively switch to the role
		- You can add MFA protection to the role
		- LPP + auditing using CloudTrail
	- Cross account access with STS
		- Creates role in account A to access account A resource
		- Grants members of account B permission to assume role in account A
		- User request access to the role
		- STS returns credentials
		- User can access
	- Providing Access to AWS Accounts Owned by Third Parties
		- Third Parties: outside your own Zone of trust
		- You need the third party AWS account ID + **an external ID**
			- Secret between you and the third party, chosen by the third party
			- To uniquely associate with the role between you and the third party
		- Define permissions in the IAM policy
		- **The confused deputy**
			- **W/out external ID you cannot verify the owner of a IAM Role**, preventing another AWS account accessing your account
	- Session Tags
		- Tags that you pass when you assume an IAM Role or federate user in STS
		- Use *aws:PrincipalTag* condition, allowing a principal to pass only if the principal making the request has the specified tags
	- Important APIs
		- **AssumeRole**: access a role
		- **AssumeRoleWithSAML**: return credentials for users logged with SAML
		- **AssumeRoleWithWebIdentity**: return credentials for users logged with IdP
			- AWS recommends using Cognito instead
		- **GetSessionTGoken**: for MFA
		- **GetFederationToken**: obtain temporary credentials for a federated user
- # Identity Federation #iam
  collapsed:: true
	- Give users outside pf AWS permissions to access AWS resources in your accounts w/out creating IAM users
		- User management is outside AWS, in a Identity Provider (IdP)
	- Use cases:
		- A corporate has its own identity system (e.g., Active Directory)
		- Web/Mobile apps that needs access to AWS resources
	- It can have many flavors:
		- **Security Assertion Markup Language 2.0 (SAML 2.0, legacy)**
			- Open standard used by many IdPs (Active Directory Federations Services)
			- Access to AWS Console, AWS CLI, or AWS API using temporary credentials:
				- No need to create IAM Users
				- Need to setup a trust between AWS IAM and IdP (both ways)
			- Uses the STS API **AssumeRoleWithSAML**
		- **Custom Identity Broker (legacy)**
			- **Use only if IdP is NOT COMPATIBLE with SAML 2.0**
			- Request temporary credentials itself, being responsable to select the appropiate IAM Role
			- Uses STS API **AssumRole** or **GetFederationToken**
		- **Web Identity Federation (Cognito)**
			- *Without Cognito* -> AWS doesn't recommend it anymore
				- STS API **AssumeRoleWithWebIdentity**
			- *With Cognito*
				- Creating IAM Roles using Cognito following LPP
				- Build trust between the OIDC IdP and AWS
				- Supports anonymous users, MFA and data sync
			- After being authenticated with Web Identity Federation, you cand identify the user with an IAM policy variable
		- **IAM Identity Center**
- # AWS Directory Services #iam
  collapsed:: true
	- Microsoft Active Directory (AD)
		- Found on any Windows Server with AD Domain Services
		- Database of objects (user, account, computer, printer, file share, security group)
		- Centralized security management, create account, assign permissions
		- object -> tree -> forest
	- Microsoft Active Directory Federation Services (ADFS)
		- Provides SSO across apps
		- SAML across third parties (e.g., AWS)
	- AWS Directory Services
		- **AWS-managed Microsoft AD**
			- Microsoft AD in your VPC
			- EC2 Windows instances can join the domain and run
			- Integrations
				- RDS for SQL Server, AWS Workspaces, Quicksight, Connect, WorkDocs, AWS SSO (SAML 2.0)
				- Traditional AD apps (.NET, SharePoint, SQL Server)
				- Extend on-prem AD (AD two-way forest trust)
			- Standalone repository on AWS or joined to on-prem AD
				- Ability to connect your on-prem AD to AWS-managed AD
				- Must establish a Direct Connect or VPN Connection (Site-to-Site)
				- One-way trust (it is valid on both ways) or two-way forest trust
				- **Forest trust is not the same as synchronization** -> replication is not supported
			- Multi AZ deployment of AD in 2 AZ, # of DC can be scaled in and scaled out
			- Automated backups, and multi-region replication of your directory
		- **AD Connector**
			- Directory gateway (proxy) to redirect directory request to your on-prem AD
			- No caching, doesn't work with SQL Server, doesn't do seamless joining, cannot share directory. Manage user solely on-prem, you cannot establish a trust.
			- Connection through VPN and DX. If network goes down, it's useless
		- **Simple AD**
			- Cost-optimized AD-compatible (Samba 4) AWS service with the common directory features.
				- Doesn't support MFA, RDS SQL Server, AWS SSO
			- Supports joining EC2 instances, manage users (small: 500 users,  large: 5000 users) and groups
			- No trust relationship
	- ## Solution Architecure: AD Replication
		- Create a replica of your AD on EC2 in the cloud to minimize latency in case DX or VPN goes down
		- Then, establish two-way forest trust between the AWS-managed AD and the EC2 AD
- # AWS Organizations #iam
  collapsed:: true
	- **Root Organizational Unit (OU)**
		- **Management Account** + other OUs
	- **OrganizationAccountAccessRole**
		- IAM Role which grants full administrator permissions in the Member account to the Management account
		- Used to perform administrator tasks in the Member accounts (creating IAM users)
		- Could be assume by IAM users in the Management account
		- Automatically added to all new Member accounts created with AWS Organizations. If you invite an existing Member account, you **MUST** create it manually
	- **Multi Account Strategies**
		- There's no guidelines, it is up to you
			- Accounts per **departament**, per **cost center**, per **environment**, based on **regulatory restrictions**, for **better resource isolation**, to **separate logging/security**, to have **separate per-account service limits**...
		- Multi Account vs. One Account Multi VPC
		- Use tagging standards for billing purposes
		- Centralize CloudTrail, CloudWatch Logs, Security on a unique account
		- OU Examples:
			- **Business Unit**
			- **Environment lifecycle**
			- **Project-based**
	- **Feature Modes**
		- Consolidated billing features:
			- Treats all the accounts in the organizations as one accounts -> single payment method
			- Pricing benefits from aggregated usage
				- Reserved Instances and Savings Plansa: by default, you can share RIs and Savings Plans between all the accounts inside the Organization. You can turn off this setting on the management account
		- All features (default):
			- Includes consolidated billing features + Service Control Policies (SCP)
				- You can apply an SCP to prevent member accounts from leaving the Organization.
			- Invited accounts **MUST** approve enabling all features.
			- Cannot switch back to Consolidated billing features only.
	- **Moving Accounts**
		- Remove the member account from the AWS Organization.
		  logseq.order-list-type:: number
		- Send an invite to the member account from the AWS Organization.
		  logseq.order-list-type:: number
		- Accept the invite to the new Organization from the member account.
		  logseq.order-list-type:: number
- # Service Control Policies (SCP) #iam
  collapsed:: true
	- Define allowlist or blocklist IAM actions
	- Applied at the OU or Account level
		- Does not apply to the Management Account
	- SCP could be applied to all the Users and Roles in the account, including Root User
		- Does not affect to Service-linked roles
	- SCP **MUST have explicit ALLOW from the root** for each OU in the direct path to the target account
	- Use cases:
		- Restrict access to certain services
		- Enforce Payment Card Industry (PCI) compliance by explicitly disabling services
		- Blocklist and Allowlist strategies: **Allow ALL. Then, DENY explicitly**
	- **IAM Policy Evaluation Logic**
		- Decision starts with implicit DENY. Then, it follows this path:
			- Organizations SCPs
			- Resource-based policies
			- Identity-based policies
			- IAM permissions boundaries
			- Session policies
	- **Restricting Tags with IAM Policies**
		- Using **aws:TagKeys** condition:
			- *ForAllValues*
			- *ForAnyValues*
		- You can also use this to restrict the resource creation without appropriate tags:
			- Using * "Null": { aws:RequestedTag/<tag_name>: "true" }* condition.
	- **Tag Policies**
		- Standardize tags across resources in an Organization, ensuring consistent tags, audit tagged resources, maintain proper resources categorization.
		- You define tag keys and their allowed values.
		- AWS Cost Allocation Tags and Attribute-based Access Control.
		- Prevent any non-compliant tagging operation on specificed services and resources. Generate a report that list all tagged/non-complient resources.
		- Use Amazon EventBridge to monitor non-compliant tags.
	- **Deny a Region**
		- Using **aws:RequestedRegion** condition.
	- **AI Services Opt-out Policies**
		- You can opt-out of having your content stored or used by AWS AI services using SCP tagging (all AI services or selected services that may use your content for continuous improvement of Amazon AI/ML services).
	- **Backup Policies**
		- AWS Backup enables you to create generic Backup Plans.
		- Gives you granular control over backing up your resources.
		- They are immutable from Member accounts (read-only). You only modify it from Management accounts.